<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Copyright and AI training protection -->
    <meta name="robots" content="noai, noimageai">
    <meta name="copyright" content="Content curation and organization © 2025 CanadaXFX. Unauthorized AI training prohibited.">

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; color: #333;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        header { text-align: center; padding: 16px 0; color: white; }
        h1 { font-size: 1.5rem; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .subtitle { font-size: 1rem; opacity: 1; }
        .nav-buttons { display: flex; justify-content: center; gap: 12px; margin: 10px 0 12px; }
        .nav-btn, .btn {
            padding: 12px 12px; border: none; border-radius: 25px; cursor: pointer;
            font-size: 14px; font-weight: 600; transition: all 0.3s ease;
            text-decoration: none; display: inline-block;
        }
        .nav-btn.active, .btn.primary {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white; transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(238, 90, 36, 0.3);
        }
        .nav-btn:not(.active) { background: rgba(255,255,255,0.2); color: white; backdrop-filter: blur(10px); }
        .nav-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0,0,0,0.2); }
        .content-section {
            background: rgba(255,255,255,0.95); border-radius: 20px; padding: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1); backdrop-filter: blur(10px);
        }
        .hidden { display: none !important; }
        .search-bar {
            width: 100%; max-width: 400px; padding: 15px; border: 2px solid #e0e0e0;
            border-radius: 25px; font-size: 14px; margin: 0 auto 10px; display: block;
            transition: border-color 0.3s ease;
        }
        .search-bar:focus { outline: none; border-color: #667eea; }
        
        /* Optimized gallery grid with better performance */
        .gallery-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); 
            gap: 12px; 
            margin-top: 20px;
            contain: layout style paint; /* CSS containment for better performance */
        }
        
        /* Photo card optimizations */
        .photo-card { 
            position: relative; 
            border-radius: 10px; 
            overflow: hidden; 
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
            cursor: pointer; 
            background: white; 
            height: 160px;
            /* Performance optimizations */
            transform: translateZ(0); /* Hardware acceleration */
            will-change: transform; /* Optimize for animations */
            contain: layout style paint;
        }
        
        /* Optimize hover effects */
        .photo-card:hover { 
            transform: translateY(-3px) translateZ(0); 
            box-shadow: 0 12px 25px rgba(0,0,0,0.2); 
        }
        
        /* Image optimizations */
        .photo-card img { 
            width: 100%; 
            height: 160px; 
            object-fit: cover; 
            display: block; 
            transition: transform 0.3s ease;
            /* Prevent layout shifts */
            aspect-ratio: 1/1.45;
        }
        
        /* Skeleton loader for images */
        .photo-card.loading {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        .photo-card:hover img { transform: scale(1.05); }
        .photo-info { 
            position: absolute; 
            bottom: 0; 
            left: 0; 
            right: 0; 
            background: linear-gradient(transparent, rgba(0,0,0,0.8)); 
            color: white; 
            padding: 15px 8px 8px; 
        }
        .photo-date { font-size: 11px; font-weight: 600; text-align: center; flex-wrap: wrap;}
        .photo-card.no-overlay { height: auto; }
        .photo-card.no-overlay .photo-info { position: static; background: white; color: #333; text-align: center; padding: 8px; border-top: 1px solid #eee; }
        .photo-card.no-overlay .photo-date { font-size: 10px; }
        .collection-overview { margin-bottom: 30px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 130px));  justify-content: center; gap: 12px; max-width: 740px; margin: 0 auto; }
        .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 10px 12px; border-radius: 15px; text-align: center; box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
        .stat-number { font-size: 1rem; font-weight: bold; margin-bottom: 5px; }
        .stat-label { font-size: 12px; opacity: 0.9; }
        .filter-section { margin-bottom: 25px; }
        .filter-tabs { display: flex; justify-content: center; gap: 2px; margin-top: 15px; flex-wrap: wrap; }
        .filter-tab { padding: 8px 16px; border: 2px solid #e0e0e0; background: white; border-radius: 20px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.3s ease; }
        .filter-tab.active { background: #667eea; color: white; border-color: #667eea; }
        .filter-tab:hover:not(.active) { border-color: #667eea; background: #f8f9ff; }
        .loading-progress { margin: 20px 0; text-align: center; }
        .progress-bar { width: 100%; max-width: 400px; height: 6px; background: #e0e0e0; border-radius: 3px; margin: 0 auto 10px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); width: 0%; transition: width 0.3s ease; }
        .progress-text { font-size: 14px; color: #666; margin: 0; }
        .load-more-section { margin-bottom: 8px; text-align: center; padding-bottom: 12px;}
        .load-more-btn { background: linear-gradient(45deg, #667eea, #764ba2); color: white; border: none; padding: 15px 30px; border-radius: 25px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; margin-bottom: 15px; display: block; margin-left: auto; margin-right: auto; }
        .load-more-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3); }
        .remaining-count { display: block; font-size: 12px; opacity: 0.8; margin-top: 5px; }
        .load-options { display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; }
        .quick-load-btn { padding: 8px 16px; border: 1px solid #667eea; background: white; color: #667eea; border-radius: 15px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.3s ease; }
        .quick-load-btn:hover { background: #667eea; color: white; }
        .view-toggle { text-align: center; margin: 20px 0; }
        .view-btn { padding: 10px 20px; border: 2px solid #e0e0e0; background: white; border-radius: 20px; cursor: pointer; font-size: 14px; font-weight: 600; margin: 0 5px; transition: all 0.3s ease; }
        .view-btn.active { background: #667eea; color: white; border-color: #667eea; }
        .timeline-section { margin-top: 20px; }
        .timeline-container { max-width: 1000px; margin: 0 auto; }
        .timeline-year { margin-bottom: 30px; border: 1px solid #e0e0e0; border-radius: 15px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .timeline-year-header { background: linear-gradient(45deg, #667eea, #764ba2); color: white; padding: 20px 25px; font-size: 14px; font-weight: bold; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: all 0.3s ease; }
        .timeline-year-header:hover { background: linear-gradient(45deg, #5a6fd8, #6a42a0); transform: translateY(-1px); }
        .timeline-year-count { font-size: 14px; opacity: 0.9; background: rgba(255,255,255,0.2); padding: 5px 12px; border-radius: 20px; }
        .timeline-year-content { padding: 25px; background: white; }
        .timeline-month { margin-bottom: 25px; }
        .timeline-month h5 { color: #667eea; margin-bottom: 15px; font-size: 16px; border-bottom: 2px solid #e0e0e0; padding-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
        .timeline-photos { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 12px; padding: 0; }
        .timeline-photo { aspect-ratio: 1; border-radius: 8px; overflow: hidden; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .timeline-photo:hover { transform: scale(1.05); box-shadow: 0 4px 15px rgba(0,0,0,0.2); z-index: 10; }
        .timeline-photo img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.3s ease; }
        .timeline-photo:hover img { transform: scale(1.1); }
        .timeline-year-header::after { content: '▼'; font-size: 14px; transition: transform 0.3s ease; margin-left: 10px; }
        .timeline-year-content[style*="none"] + .timeline-year-header::after,
        .timeline-year-header[aria-expanded="false"]::after { transform: rotate(-90deg); }
        .timeline-empty { text-align: center; padding: 60px 20px; color: #666; background: white; border-radius: 15px; border: 2px dashed #e0e0e0; }
        .timeline-empty h3 { color: #667eea; margin-bottom: 10px; }
        .game-container { text-align: center; }
        .game-stats { display: flex; justify-content: center; gap: 2px; margin: 20px 0; flex-wrap: wrap; }
        .stat { background: linear-gradient(45deg, #667eea, #764ba2); color: white; padding: 15px 15px; border-radius: 15px; font-size: 14px; font-weight: 600;}
        .game-photo { max-width: 400px; max-height: 400px; width: 100%; height: 300px; object-fit: contain; object-position: center center; background: #f5f5f7; border-radius: 15px; box-shadow: 0 15px 35px rgba(0,0,0,0.2); margin: 20px auto; display: block; }
        .options { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; max-width: 600px; margin: 30px auto; }
        .option-btn { padding: 15px; border: 2px solid #e0e0e0; background: white; border-radius: 15px; cursor: pointer; font-size: 16px; font-weight: 600; transition: all 0.3s ease; }
        .option-btn:hover { border-color: #667eea; background: #f8f9ff; transform: translateY(-2px); }
        .option-btn.correct { background: linear-gradient(45deg, #2ed573, #1dd1a1); color: white; border-color: #2ed573; }
        .option-btn.incorrect { background: linear-gradient(45deg, #ff4757, #ff3742); color: white; border-color: #ff4757; }
        .game-result { margin: 20px 0; padding: 15px; border-radius: 10px; font-weight: 600; font-size: 14px; }
        .game-result.correct { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .game-result.incorrect { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8);
            display: flex; align-items: center; justify-content: center; z-index: 1000; padding: 20px; }
        .modal-content { background: white; border-radius: 15px; padding: 30px; max-width: 500px; width: 100%; text-align: center; position: relative; }
        .modal img { max-width: 100%; max-height: 400px; border-radius: 10px; margin-bottom: 20px; }
        .close-modal { position: absolute; top: 10px; right: 15px; background: none; border: none; font-size: 24px; cursor: pointer; color: #666; }
        .section-title{  font-size: 1rem; line-height: 1.25; margin: 6px 0 8px;}

        /* Optimized back to top button */
        #back-to-top {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #667eea;
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 80%;
            text-align: center;
            line-height: 48px;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            z-index: 9999;
            touch-action: manipulation;
            transform: translateZ(0); /* Hardware acceleration */
        }
        #back-to-top.visible {
            opacity: 1;
            visibility: visible;
        }
        #back-to-top:hover {
            background-color: #764ba2;
            transform: scale(1.1) translateZ(0);
        }

        /* Mobile optimizations */
        @media (max-width: 768px) {
            header { padding: 8px 0 6px; }
            .header-cta{ margin-top: 2px; font-size: 11px; }
            .nav-buttons { margin: 6px 0 8px; gap: 8px; }
            .nav-btn, .btn { padding: 10px 10px; font-size: 13px; }

            #back-to-top { bottom: 80px; right: 20px; }
            .gallery-grid { 
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
            }
            .stats-grid {
                grid-template-columns: repeat(3, minmax(0, 1fr));
                gap: 8px;
                max-width: 100%;
            }
            .game-stats {
                display: flex;
                flex-wrap: nowrap;
                justify-content: space-between;
                gap: 6px;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                padding: 0 4px;
            }
            .game-stats .stat {
                flex: 1 0 0;
                white-space: nowrap;
                padding: 10px 8px;
                font-size: 12px;
                text-align: center;
            }
        }

        .header-cta{
            display:inline-block;
            margin-top:6px;
            font-size:12px;
            color:#fff;
            text-decoration: underline;
            opacity:.95;
        }
        .header-cta:hover{ opacity:1; }
        #explore-links .footer-link{ margin: 4px 6px; }
        .content-section > *:last-child{ margin-bottom: 0 !important; }

        /* Performance hint for animations */
        .photo-card, .nav-btn, .btn, .filter-tab, .view-btn {
            will-change: transform;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Xiao Zhan Studio Gallery<br>肖战工作室高清相册</h1>
            <p class="subtitle" style="font-weight: 600; color: white;">Explore high-resolution photos from XZ Studio on Weibo and test your memory! </p>
            <a href="#explore-links" class="header-cta">Explore links ↓</a>
        </header>

        <nav class="nav-buttons">
            <button class="nav-btn active" data-section="gallery">Photo Gallery<br>工作室相册</button>
            <button class="nav-btn" data-section="game">Time Game<br>时间游戏</button>
        </nav>

        <!-- Gallery Section -->
        <div id="gallery-section" class="content-section">
            <div class="collection-overview">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalPhotosDisplay">0</div>
                        <div class="stat-label">Total Photos</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="yearsSpanDisplay">0</div>
                        <div class="stat-label">Years Covered</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="showingCountDisplay">0</div>
                        <div class="stat-label">Currently Showing</div>
                    </div>
                </div>
            </div>

            <div class="filter-section">
                <input type="text" class="search-bar" placeholder="Search photos by date, year, or tags..." id="searchInput">
                <div class="filter-tabs" id="filterTabs">
                    <button class="filter-tab active" data-filter="all">All Photos</button>
                    <button class="filter-tab" data-filter="recent">Recent</button>
                </div>
            </div>

            <div class="view-toggle">
                <button class="view-btn active" data-view="grid">Grid View</button>
                <button class="view-btn" data-view="timeline">Timeline View</button>
            </div>

            <div class="loading-progress hidden" id="loadingProgress">
                <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
                <p class="progress-text" id="progressText">Loading photos...</p>
            </div>

            <div class="gallery-grid" id="galleryGrid"></div>

            <div class="load-more-section hidden" id="loadMoreSection">
                <button class="load-more-btn" id="loadMoreBtn">
                    Load More Photos
                    <span class="remaining-count" id="remainingCount">(999+ remaining)</span>
                </button>
                <div class="load-options">
                    <button class="quick-load-btn" onclick="loadPhotos(20)">+20</button>
                    <button class="quick-load-btn" onclick="loadPhotos(50)">+50</button>
                    <button class="quick-load-btn" onclick="loadAllPhotos()">Load All</button>
                </div>
            </div>

            <div class="timeline-section hidden" id="timelineSection">
                <div class="timeline-container" id="timelineContainer"></div>
            </div>
        </div>

        <!-- Game Section -->
        <div id="game-section" class="content-section hidden">
            <div class="game-container">
                <h2 class="section-title">When Was This Photo Taken?</h2>
                <p style="font-size:13px; color:#1565C0;">Click "Start Game" to begin!</p>
                <div style="background:#e8f4ff; padding:15px; border-radius:10px; margin:20px auto; max-width:500px; border-left:4px solid #2196F3;">
                    <p style="margin:0; font-size:12px; color:#1565C0;"><strong>💡 猜猜看:</strong> 相框里的照片是什么时候照的？<br>点击"开始游戏！"，测试你的眼力吧！</p>
                </div>
                <div class="game-stats">
                    <div class="stat">Score: <span id="score">0</span></div>
                    <div class="stat">Streak: <span id="streak">0</span></div>
                    <div class="stat">Total: <span id="totalQuestions">0</span></div>
                </div>
                <div id="gameContent">
                    <img id="gamePhoto" class="game-photo" alt="Guess the date">
                    <div id="gameOptions" class="options"></div>
                    <div id="gameResult" class="game-result hidden"></div>
                    <button id="nextQuestion" class="btn primary hidden">Next Question</button>
                </div>
                <div class="game-controls">
                    <button id="startGame" class="btn primary">Start Game 开始游戏！</button>
                    <button id="newGame" class="btn primary hidden">New Game</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Photo Modal -->
    <div id="photoModal" class="modal hidden">
        <div class="modal-content">
            <button class="close-modal" onclick="closeModal()">&times;</button>
            <img id="modalPhoto" alt="Full size photo">
            <h3 id="modalTitle"></h3>
            <p id="modalDate"></p>
            <div class="share-buttons">
                <a class="share-btn" id="weiboLinkBtn" target="_blank" rel="noopener"
                   style="background:#fa2a55; color:white; display:none;">Weibo Link</a>
            </div>
        </div>
    </div>

    <!-- Back to Top Button -->
    <div id="back-to-top">↑</div>

    <script>
        /* ---------- Optimized Performance Variables ---------- */
        let photoData = [];
        let gameScore = 0, gameStreak = 0, totalQuestions = 0, currentPhoto = null, gameActive = false;
        let displayedPhotos = [], filteredPhotos = [], currentFilter = 'all', currentView = 'grid', loadedCount = 0;
        
        // Reduced initial load for better performance
        let photosPerLoad = 20; // Reduced from 100 to 20
        let imageCache = new Map(); // Image caching
        let isLoading = false; // Prevent multiple simultaneous loads
        
        // Intersection Observer for lazy loading
        let imageObserver = null;
        
        // Debounce function for search
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        document.addEventListener('DOMContentLoaded', () => {
            setupNavigation();
            setupSearch();
            setupViewToggle();
            setupIntersectionObserver();
            loadPhotoData();
        });

        /* ---------- Optimized Image Loading ---------- */
        function setupIntersectionObserver() {
            imageObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const img = entry.target;
                        const photoCard = img.closest('.photo-card');
                        
                        if (img.dataset.src && !img.src) {
                            img.src = img.dataset.src;
                            img.onload = () => {
                                photoCard.classList.remove('loading');
                                img.removeAttribute('data-src');
                            };
                            img.onerror = () => {
                                photoCard.classList.remove('loading');
                                img.alt = 'Failed to load';
                            };
                        }
                        imageObserver.unobserve(img);
                    }
                });
            }, {
                rootMargin: '50px'
            });
        }

        /* ---------- Optimized Data Loading ---------- */
        async function loadPhotoData() {
            if (isLoading) return;
            isLoading = true;
            
            showLoadingProgress();
            const cacheBuster = Date.now();
            try {
                const res = await fetch(`photoData.json?v=${cacheBuster}`, { 
                    cache: 'no-store',
                    // Add timeout
                    signal: AbortSignal.timeout(10000)
                });
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();
                if (!Array.isArray(data)) throw new Error('JSON is not an array');
                
                photoData = data;
                
                // Process data in chunks to avoid blocking
                await processDataInChunks();
                
            } catch (err) {
                console.error('Failed to load photoData.json:', err);
                alert('Could not load photo data. Please check your connection and try again.');
            } finally {
                hideLoadingProgress();
                isLoading = false;
            }
        }

        /* ---------- Chunk Processing for Better Performance ---------- */
        async function processDataInChunks() {
            return new Promise((resolve) => {
                // Use requestIdleCallback for better performance
                if (window.requestIdleCallback) {
                    requestIdleCallback(() => {
                        initializeAppAfterData();
                        resolve();
                    });
                } else {
                    setTimeout(() => {
                        initializeAppAfterData();
                        resolve();
                    }, 0);
                }
            });
        }

        function initializeAppAfterData() {
            generateDynamicFilters();
            setupFilters();
            updateCollectionStats();
            loadGallery(true);
            initializeGame();
        }

        /* ---------- Navigation ---------- */
        function setupNavigation() {
            const navBtns = document.querySelectorAll('.nav-btn');
            navBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const section = this.getAttribute('data-section');
                    showSection(section);
                    navBtns.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                });
            });
        }
        
        function showSection(section) {
            document.querySelectorAll('.content-section').forEach(s => s.classList.add('hidden'));
            document.getElementById(section + '-section').classList.remove('hidden');
            if (section === 'game') initializeGame();
        }

        /* ---------- Optimized Filters & Stats ---------- */
        function generateDynamicFilters() {
            const availableYears = [...new Set(photoData.map(p => p.year))]
                .sort((a, b) => parseInt(b) - parseInt(a));
            const filterTabsContainer = document.getElementById('filterTabs');
            const staticButtons = `
                <button class="filter-tab active" data-filter="all">All Photos</button>
                <button class="filter-tab" data-filter="recent">Recent</button>
            `;
            const yearButtons = availableYears.map(year => 
                `<button class="filter-tab" data-filter="${year}">${year}</button>`
            ).join('');
            filterTabsContainer.innerHTML = staticButtons + yearButtons;
        }

        function setupFilters() {
            const filterTabs = document.querySelectorAll('.filter-tab');
            filterTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const filter = this.getAttribute('data-filter');
                    setFilter(filter);
                    filterTabs.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                });
            });
        }

        function setFilter(filter) {
            currentFilter = filter; 
            loadedCount = 0;
            
            switch(filter) {
                case 'all': 
                    filteredPhotos = [...photoData]; 
                    break;
                case 'recent':
                    const sixMonthsAgo = new Date(); 
                    sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 6);
                    filteredPhotos = photoData.filter(p => new Date(p.date) >= sixMonthsAgo); 
                    break;
                default: 
                    filteredPhotos = photoData.filter(p => p.year === filter);
            }
            
            filteredPhotos.sort((a,b) => new Date(b.date) - new Date(a.date));
            loadGallery(true);
        }

        function updateCollectionStats() {
            const totalPhotos = photoData.length;
            const yearsSpan = new Set(photoData.map(p => p.year)).size;
            
            // Use requestAnimationFrame for smooth updates
            requestAnimationFrame(() => {
                document.getElementById('totalPhotosDisplay').textContent = totalPhotos.toLocaleString();
                document.getElementById('yearsSpanDisplay').textContent = yearsSpan;
                document.getElementById('showingCountDisplay').textContent = Math.min(loadedCount, filteredPhotos.length);
                
                const remaining = Math.max(0, filteredPhotos.length - loadedCount);
                document.getElementById('remainingCount').textContent = 
                    remaining > 0 ? `(${remaining.toLocaleString()} remaining)` : '(All loaded)';
                
                const loadMoreSection = document.getElementById('loadMoreSection');
                if (currentView === 'grid' && remaining > 0) {
                    loadMoreSection.classList.remove('hidden');
                } else {
                    loadMoreSection.classList.add('hidden');
                }
            });
        }

        /* ---------- View toggle ---------- */
        function setupViewToggle() {
            const viewBtns = document.querySelectorAll('.view-btn');
            viewBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const view = this.getAttribute('data-view');
                    switchView(view);
                    viewBtns.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                });
            });
        }
        
        function switchView(view) {
            currentView = view;
            const galleryGrid = document.getElementById('galleryGrid');
            const timelineSection = document.getElementById('timelineSection');
            const loadMoreSection = document.getElementById('loadMoreSection');
            
            if (view === 'timeline') {
                galleryGrid.style.display = 'none'; 
                loadMoreSection.classList.add('hidden');
                timelineSection.classList.remove('hidden'); 
                loadTimelineView();
            } else {
                galleryGrid.style.display = 'grid'; 
                timelineSection.classList.add('hidden');
                updateCollectionStats();
            }
        }

        /* ---------- Optimized Gallery Loading ---------- */
        function loadGallery(reset = false) {
            if (isLoading) return;
            
            if (reset) { 
                loadedCount = 0; 
                displayedPhotos = []; 
            }
            
            if (filteredPhotos.length === 0 && photoData.length > 0) {
                filteredPhotos = [...photoData].sort((a, b) => new Date(b.date) - new Date(a.date));
            }
            
            const grid = document.getElementById('galleryGrid');
            if (photoData.length === 0) {
                grid.innerHTML = '<div style="text-align:center; padding:40px; color:#666;">No photos yet. Add photoData.json to your repository.</div>';
                return;
            }
            
            if (!reset) {
                showLoadingProgress();
            }
            
            // Use requestIdleCallback for better performance
            if (window.requestIdleCallback) {
                requestIdleCallback(() => loadPhotosChunk(photosPerLoad, reset));
            } else {
                setTimeout(() => loadPhotosChunk(photosPerLoad, reset), 10);
            }
        }

        function loadPhotosChunk(count, reset = false) {
            if (isLoading && !reset) return;
            isLoading = true;
            
            const startIndex = reset ? 0 : loadedCount;
            const endIndex = Math.min(startIndex + count, filteredPhotos.length);
            const photosToLoad = filteredPhotos.slice(startIndex, endIndex);
            
            if (reset) {
                displayedPhotos = photosToLoad;
            } else {
                displayedPhotos = displayedPhotos.concat(photosToLoad);
            }
            
            loadedCount = displayedPhotos.length;
            const grid = document.getElementById('galleryGrid');
            
            if (reset) {
                grid.innerHTML = '';
            }
            
            // Create document fragment for better performance
            const fragment = document.createDocumentFragment();
            
            photosToLoad.forEach(photo => {
                const photoCard = document.createElement('div');
                photoCard.className = 'photo-card loading';
                photoCard.onclick = () => openPhotoModal(photo.id);
                
                photoCard.innerHTML = `
                    <img data-src="${photo.url}" alt="Photo ${photo.id}" loading="lazy">
                    <div class="photo-info">
                        <div class="photo-date">${photo.month} ${photo.year}</div>
                    </div>
                `;
                
                fragment.appendChild(photoCard);
                
                // Set up intersection observer for lazy loading
                const img = photoCard.querySelector('img');
                if (imageObserver) {
                    imageObserver.observe(img);
                }
            });
            
            grid.appendChild(fragment);
            
            hideLoadingProgress();
            updateCollectionStats();
            isLoading = false;
        }

        function loadPhotos(count) { 
            if (!isLoading) {
                loadPhotosChunk(count); 
            }
        }
        
        function loadAllPhotos() { 
            const remaining = filteredPhotos.length - loadedCount; 
            if (remaining > 0 && !isLoading) {
                loadPhotosChunk(remaining); 
            }
        }
        
        document.getElementById('loadMoreBtn').addEventListener('click', () => loadPhotos(photosPerLoad));

        /* ---------- Optimized Search ---------- */
        function setupSearch() {
            const searchInput = document.getElementById('searchInput');
            const debouncedSearch = debounce(performSearch, 300);
            
            searchInput.addEventListener('input', function() {
                const query = this.value.toLowerCase();
                debouncedSearch(query);
            });
        }
        
        function performSearch(query) {
            if (!query.trim()) { 
                setFilter(currentFilter); 
                return; 
            }
            
            // Optimize search performance
            const searchResults = photoData.filter(photo => {
                const monthMatch = photo.month.toLowerCase().includes(query);
                const yearMatch = photo.year.includes(query);
                const dateMatch = photo.date.includes(query);
                const tagsMatch = Array.isArray(photo.tags) && 
                    photo.tags.some(tag => String(tag).toLowerCase().includes(query));
                
                return monthMatch || yearMatch || dateMatch || tagsMatch;
            });
            
            filteredPhotos = searchResults.sort((a, b) => new Date(b.date) - new Date(a.date));
            loadedCount = 0; 
            loadGallery(true);
        }

        /* ---------- Timeline (unchanged for space) ---------- */
        function loadTimelineView() {
            const container = document.getElementById('timelineContainer');
            const photosByYear = {};
            filteredPhotos.forEach(photo => {
                if (!photosByYear[photo.year]) photosByYear[photo.year] = [];
                photosByYear[photo.year].push(photo);
            });
            const timelineHTML = Object.entries(photosByYear).sort(([a],[b]) => b - a).map(([year, photos]) => `
                <div class="timeline-year">
                    <div class="timeline-year-header" onclick="toggleTimelineYear('${year}')">
                        <span>${year}</span><span class="timeline-year-count">${photos.length} photos</span>
                    </div>
                    <div class="timeline-photos" id="timeline-${year}">
                        ${photos.slice(0,50).map(photo => `
                            <div class="timeline-photo" onclick="openPhotoModal(${photo.id})">
                                <img src="${photo.url}" alt="Photo ${photo.id}" loading="lazy">
                            </div>`).join('')}
                        ${photos.length > 50 ? `<div style="grid-column:1/-1; text-align:center; padding:10px; color:#666;">And ${photos.length - 50} more photos...</div>` : ''}
                    </div>
                </div>`).join('');
            container.innerHTML = timelineHTML;
        }
        
        function toggleTimelineYear(year) {
            const photosDiv = document.getElementById(`timeline-${year}`);
            photosDiv.style.display = photosDiv.style.display === 'none' ? 'grid' : 'none';
        }

        /* ---------- Modal & Game (unchanged) ---------- */
        function openPhotoModal(photoId) {
            const photo = photoData.find(p => p.id === photoId);
            if (!photo) return;
            document.getElementById('modalPhoto').src = photo.url;
            document.getElementById('modalTitle').textContent = `Photo ${photo.id}`;
            document.getElementById('modalDate').textContent = `Taken in ${photo.month} ${photo.year}`;
            const weiboBtn = document.getElementById('weiboLinkBtn');
            if (photo.weibo && typeof photo.weibo === 'string' && photo.weibo.trim()) {
                const w = photo.weibo.trim();
                const normalized = /^https?:\/\//i.test(w) ? w : `https://${w}`;
                weiboBtn.href = normalized; weiboBtn.style.display = 'inline-block';
            } else {
                weiboBtn.style.display = 'none';
            }
            document.getElementById('photoModal').classList.remove('hidden');
        }
        
        function closeModal() { 
            document.getElementById('photoModal').classList.add('hidden'); 
        }

        // Game controls
        document.getElementById('startGame').addEventListener('click', startGame);
        document.getElementById('newGame').addEventListener('click', newGame);
        document.getElementById('nextQuestion').addEventListener('click', nextQuestion);

        function initializeGame() {
            if (!gameActive && photoData.length > 0) {
                document.getElementById('gamePhoto').src = createDefaultGameImage();
            } else if (photoData.length === 0) {
                document.getElementById('gamePhoto').src = createDefaultGameImage();
                const startBtn = document.getElementById('startGame');
                startBtn.textContent = 'Add Photos First'; startBtn.disabled = true; startBtn.style.opacity = '0.5';
            }
        }
        
        function startGame() {
            if (photoData.length === 0) { alert('No photos available for the game!'); return; }
            gameActive = true; document.getElementById('startGame').classList.add('hidden');
            document.getElementById('newGame').classList.remove('hidden'); nextQuestion();
        }
        
        function newGame() {
            if (photoData.length === 0) { alert('No photos available for the game!'); return; }
            gameScore = 0; gameStreak = 0; totalQuestions = 0; updateGameStats(); nextQuestion();
        }
        
        function nextQuestion() {
            if (photoData.length === 0) { alert('No photos available for the game!'); return; }
            document.getElementById('gameResult').classList.add('hidden');
            document.getElementById('nextQuestion').classList.add('hidden');
            currentPhoto = photoData[Math.floor(Math.random() * photoData.length)];
            document.getElementById('gamePhoto').src = currentPhoto.url;
            const options = generateOptions(currentPhoto); displayGameOptions(options);
        }
        
        function generateOptions(correctPhoto) {
            const months = ['January','February','March','April','May','June','July','August','September','October','November','December'];
            const years = [...new Set(photoData.map(p => p.year))];
            const options = [`${correctPhoto.month} ${correctPhoto.year}`];
            while (options.length < 4) {
                const randomMonth = months[Math.floor(Math.random()*months.length)];
                const randomYear = years[Math.floor(Math.random()*years.length)] || correctPhoto.year;
                const option = `${randomMonth} ${randomYear}`;
                if (!options.includes(option)) options.push(option);
            }
            return options.sort(() => Math.random() - 0.5);
        }
        
        function displayGameOptions(options) {
            const optionsContainer = document.getElementById('gameOptions');
            optionsContainer.innerHTML = options.map(option => 
                `<button class="option-btn" onclick="selectOption('${option}')">${option}</button>`
            ).join('');
        }
        
        function selectOption(selectedOption) {
            const correctAnswer = `${currentPhoto.month} ${currentPhoto.year}`;
            const isCorrect = selectedOption === correctAnswer; totalQuestions++;
            if (isCorrect) { gameScore++; gameStreak++; showGameResult('Correct!', 'correct'); }
            else { gameStreak = 0; showGameResult(`Wrong! It was ${correctAnswer}`, 'incorrect'); }
            updateGameStats(); highlightOptions(selectedOption, correctAnswer);
            document.getElementById('nextQuestion').classList.remove('hidden');
        }
        
        function showGameResult(message, type) {
            const resultDiv = document.getElementById('gameResult');
            resultDiv.textContent = message; resultDiv.className = `game-result ${type}`; resultDiv.classList.remove('hidden');
        }
        
        function highlightOptions(selectedOption, correctAnswer) {
            const optionBtns = document.querySelectorAll('.option-btn');
            optionBtns.forEach(btn => {
                btn.style.pointerEvents = 'none';
                if (btn.textContent === correctAnswer) btn.classList.add('correct');
                else if (btn.textContent === selectedOption && selectedOption !== correctAnswer) btn.classList.add('incorrect');
            });
        }
        
        function updateGameStats() {
            document.getElementById('score').textContent = gameScore;
            document.getElementById('streak').textContent = gameStreak;
            document.getElementById('totalQuestions').textContent = totalQuestions;
        }

        // Close modal when clicking outside
        document.getElementById('photoModal').addEventListener('click', function(e) { 
            if (e.target === this) closeModal(); 
        });
        document.addEventListener('keydown', function(e) { 
            if (e.key === 'Escape') closeModal(); 
        });

        /* ---------- Misc Functions ---------- */
        function createDefaultGameImage() {
            const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="400" height="300" viewBox="0 0 400 300">
                <defs>
                    <linearGradient id="bg" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#667eea;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#764ba2;stop-opacity:1" />
                    </linearGradient>
                    <linearGradient id="cardGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#ffffff;stop-opacity:0.95" />
                        <stop offset="100%" style="stop-color:#f8f9fa;stop-opacity:0.9" />
                    </linearGradient>
                </defs>
                <rect width="400" height="300" fill="url(#bg)"/>
                <rect x="30" y="30" width="340" height="240" rx="15" fill="url(#cardGrad)" opacity="0.95"/>
                <text x="200" y="65" text-anchor="middle" font-family="Arial, sans-serif" font-size="20" font-weight="bold" fill="#333">Guess the Date!</text>
                <text x="200" y="85" text-anchor="middle" font-family="Arial, sans-serif" font-size="13" fill="#666">Look at photos and guess when they were taken</text>
                <rect x="150" y="100" width="100" height="75" rx="10" fill="#f0f0f0" stroke="#ddd" stroke-width="2"/>
                <text x="200" y="130" text-anchor="middle" font-family="Arial, sans-serif" font-size="20" fill="#999">📷</text>
                <text x="200" y="148" text-anchor="middle" font-family="Arial, sans-serif" font-size="11" fill="#999">Your Photo Here</text>
                <rect x="60" y="185" width="60" height="25" rx="12" fill="#e3f2fd" stroke="#2196F3" stroke-width="1"/>
                <text x="90" y="200" text-anchor="middle" font-family="Arial, sans-serif" font-size="11" fill="#1976D2">Jan</text>
                <rect x="140" y="185" width="60" height="25" rx="12" fill="#e8f5e9" stroke="#4CAF50" stroke-width="1"/>
                <text x="170" y="200" text-anchor="middle" font-family="Arial, sans-serif" font-size="11" fill="#2E7D32">Jun</text>
                <rect x="220" y="185" width="60" height="25" rx="12" fill="#fff3e0" stroke="#FF9800" stroke-width="1"/>
                <text x="250" y="200" text-anchor="middle" font-family="Arial, sans-serif" font-size="11" fill="#F57C00">Sep</text>
                <rect x="300" y="185" width="60" height="25" rx="12" fill="#fce4ec" stroke="#E91E63" stroke-width="1"/>
                <text x="330" y="200" text-anchor="middle" font-family="Arial, sans-serif" font-size="11" fill="#C2185B">Dec</text>
                <text x="200" y="225" text-anchor="middle" font-family="Arial, sans-serif" font-size="13" font-weight="600" fill="#667eea">Ready to test your memory?</text>
                <text x="200" y="245" text-anchor="middle" font-family="Arial, sans-serif" font-size="13" font-weight="600" fill="#764ba2">Click "Start Game" to begin!</text>
            </svg>`;
            return 'data:image/svg+xml,' + encodeURIComponent(svg);
        }

        /* ---------- Optimized Loading Progress ---------- */
        function showLoadingProgress() {
            const progressDiv = document.getElementById('loadingProgress');
            const progressFill = document.getElementById('progressFill');
            
            progressDiv.classList.remove('hidden');
            
            let progress = 0;
            const interval = setInterval(() => {
                progress += 15; // Faster progress updates
                progressFill.style.width = Math.min(progress, 90) + '%';
                if (progress >= 90) clearInterval(interval);
            }, 30); // Shorter intervals
        }
        
        function hideLoadingProgress() { 
            document.getElementById('loadingProgress').classList.add('hidden'); 
        }

        /* ---------- Optimized Back to Top ---------- */
        (function(){
            const btn = document.getElementById('back-to-top');
            if (!btn) return;
            
            let ticking = false;
            
            function updateBackToTop() {
                if (window.scrollY > 300) {
                    btn.classList.add('visible');
                } else {
                    btn.classList.remove('visible');
                }
                ticking = false;
            }
            
            window.addEventListener('scroll', function() {
                if (!ticking) {
                    requestAnimationFrame(updateBackToTop);
                    ticking = true;
                }
            });
            
            btn.addEventListener('click', function() {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
        })();
    </script>

    <!-- Footer (same as original) -->
    <style>
        .site-footer {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 0;
            margin-top: 50px;
            text-align: center;
            padding-bottom: 4px;
        }

        .site-footer .footer-content:last-child { margin-bottom: 0; }

        .footer-content { margin-bottom: 6px; }
        .footer-link {
            color: white;
            text-decoration: underline;
            font-weight: 700;
            display: inline-block;
            padding: 6px 6px;
            border-radius: 6px;
            transition: all .2s ease;
        }
        .footer-link:hover { opacity: .9; transform: translateY(-1px); }
        #terms-content {
            background-color: rgba(255,255,255,0.1);
            border-radius: 8px;
            margin: 12px auto 0;
            text-align: left;
            max-width: 700px;
            margin-top: 6px;
            padding: 10px 12px; 
        }
        #terms-content ul { list-style: disc; padding-left: 20px;  margin: 6px 0 6px; }
        #terms-content li { margin: 2px 2px; }
        #terms-toggle {
            display: inline-block;
            background: rgba(255,255,255,0.15);
            border-radius: 999px;
            padding: 8px 12px; 
            border-radius: 10px;
            line-height: 1.15; 
        }
        #terms-toggle:hover{
            text-decoration: none;
            background: rgba(0,0,0,0.06);
        }
        .copyright-notice {
            opacity: .9;
            margin-top: 0px;
            font-size: 0.95rem;
            margin-bottom:12px;
        }

        @media (min-width: 1024px){
            #gallery-section .view-toggle{ 
                margin-bottom: 0 !important; 
                padding-bottom: 6px !important; 
            }
            #gallery-section .load-more-section{ 
                margin-bottom: 4px !important; 
                padding-bottom: 8px !important; 
            }
            #gallery-section .timeline-section{
                margin-bottom: 0 !important;
            }
            .site-footer{ padding-bottom: 4px !important; }
        }
    </style>
    
    <footer class="site-footer">
        <div class="footer-content">
            <div class="footer-content" id="explore-links">
                <div style="margin-bottom:6px;font-weight:700;">Explore more</div>
                <a class="footer-link" href="https://canadaxfx.github.io/XZworks/" target="_blank" rel="noopener">Screen Arts of Xiao Zhan</a>
                <a class="footer-link" href="https://www.youtube.com/@CanadaXFX" target="_blank" rel="noopener">CanadaXFX YouTube Channel</a>
            </div>

            <div class="copyright-notice">&copy; 2025 CanadaXFX. All rights reserved.</div>

            <a href="#" id="terms-toggle" class="footer-link">Terms of Use</a>
            <div id="terms-content" style="display:none;">
                <ul>
                    <li>All images and content related to Xiao Zhan belong to their respective copyright owners.</li>
                    <li>All content on this site is curated and organized © 2025 CanadaXFX.</li>
                    <li>AI training is strictly prohibited.</li>
                    <li>The original content, design, and code of this website may not be reproduced, distributed, or used without explicit permission.</li>
                    <li>Personal and non-commercial use only.</li>
                </ul>
            </div>
        </div>
    </footer>
    
    <script>
        (function(){
            var t=document.getElementById('terms-toggle');
            if(t) t.addEventListener('click', function(e){
                e.preventDefault();
                var c=document.getElementById('terms-content');
                if(c) c.style.display = (c.style.display==='none'||!c.style.display)?'block':'none';
            });
        })();
    </script>
</body>
</html>