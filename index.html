<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Copyright and AI training protection -->
    <meta name="robots" content="noai, noimageai">
    <meta name="copyright" content="Content curation and organization Â© 2025 CanadaXFX. Unauthorized AI training prohibited.">

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; color: #333;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        header { text-align: center; padding: 16px 0; color: white; }
        h1 { font-size: 1.5rem; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .subtitle { font-size: 1rem; opacity: 1; }
        .nav-buttons { display: flex; justify-content: center; gap: 12px; margin: 10px 0 12px; }
        .nav-btn, .btn {
            padding: 12px 12px; border: none; border-radius: 25px; cursor: pointer;
            font-size: 14px; font-weight: 600; transition: all 0.3s ease;
            text-decoration: none; display: inline-block;
        }
        .nav-btn.active, .btn.primary {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white; transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(238, 90, 36, 0.3);
        }
        .nav-btn:not(.active) { background: rgba(255,255,255,0.2); color: white; backdrop-filter: blur(10px); }
        .nav-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0,0,0,0.2); }
        .content-section {
            background: rgba(255,255,255,0.95); border-radius: 20px; padding: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1); backdrop-filter: blur(10px);
        }
        .hidden { display: none !important; }
        
        /* Search and Filter Styles */
        .search-bar {
            width: 100%; max-width: 400px; padding: 15px; border: 2px solid #e0e0e0;
            border-radius: 25px; font-size: 14px; margin: 0 auto 20px; display: block;
            transition: border-color 0.3s ease;
        }
        .search-bar:focus { outline: none; border-color: #667eea; }
        
        /* Stats Grid */
        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(120px, 130px));  
            justify-content: center; 
            gap: 12px; 
            max-width: 740px; 
            margin: 0 auto 20px; 
        }
        .stat-card { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            padding: 10px 12px; 
            border-radius: 15px; 
            text-align: center; 
            box-shadow: 0 8px 20px rgba(0,0,0,0.1); 
        }
        .stat-number { font-size: 1rem; font-weight: bold; margin-bottom: 5px; }
        .stat-label { font-size: 12px; opacity: 0.9; }

        /* Optimized Timeline Styles */
        .timeline-container { 
            max-width: 1000px; 
            margin: 0 auto; 
        }
        
        .timeline-year { 
            margin-bottom: 20px; 
            border: 1px solid #e0e0e0; 
            border-radius: 15px; 
            overflow: hidden; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.08); 
            background: white;
        }
        
        .timeline-year-header { 
            background: linear-gradient(45deg, #667eea, #764ba2); 
            color: white; 
            padding: 15px 20px; 
            font-size: 16px; 
            font-weight: bold; 
            cursor: pointer; 
            transition: all 0.3s ease;
            user-select: none;
            position: relative;
        }
        
        .timeline-year-header::after {
            content: "Click to view " attr(data-photo-count) " photos";
            position: absolute;
            bottom: 5px;
            left: 20px;
            font-size: 11px;
            opacity: 0.8;
            font-weight: normal;
            font-style: italic;
        }
        
        .timeline-year-header:hover { 
            background: linear-gradient(45deg, #5a6fd8, #6a42a0); 
            transform: translateY(-1px); 
        }
        
        .year-header-content {
            width: 100%;
        }
        
        .year-header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .year-title {
            font-size: 16px;
            font-weight: bold;
        }
        
        .year-preview {
            display: flex;
            gap: 6px;
            align-items: center;
            margin-top: 8px;
            opacity: 0.9;
        }
        
        .timeline-year.expanded .year-preview {
            display: none;
        }
        
        .preview-thumb {
            width: 32px;
            height: 32px;
            object-fit: cover;
            border-radius: 6px;
            border: 2px solid rgba(255,255,255,0.3);
            transition: all 0.3s ease;
        }
        
        .preview-thumb:hover {
            transform: scale(1.1);
            border-color: rgba(255,255,255,0.6);
        }
        
        .preview-more {
            background: rgba(255,255,255,0.2);
            color: white;
            padding: 6px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            border: 1px solid rgba(255,255,255,0.3);
        }
        
        .timeline-year-count { 
            font-size: 14px; 
            opacity: 0.9; 
            background: rgba(255,255,255,0.2); 
            padding: 5px 12px; 
            border-radius: 20px; 
        }
        
        .expand-icon {
            font-size: 12px;
            transition: transform 0.3s ease;
            margin-left: 10px;
        }
        
        .timeline-year.expanded .expand-icon {
            transform: rotate(180deg);
        }
        
        .timeline-year-content { 
            padding: 20px; 
            background: white;
            display: none;
        }
        
        .timeline-year.expanded .timeline-year-content {
            display: block;
        }
        
        /* Photo Grid within Year */
        .year-photos-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); 
            gap: 12px; 
            margin-bottom: 15px;
        }
        
        .timeline-photo { 
            aspect-ratio: 1; 
            border-radius: 10px; 
            overflow: hidden; 
            cursor: pointer; 
            transition: all 0.3s ease; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: relative;
            background: #f0f0f0;
        }
        
        .timeline-photo:hover { 
            transform: translateY(-3px); 
            box-shadow: 0 8px 20px rgba(0,0,0,0.2); 
        }
        
        .timeline-photo img { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
            transition: transform 0.3s ease; 
        }
        
        .timeline-photo:hover img { 
            transform: scale(1.05); 
        }
        
        /* Photo overlay info */
        .photo-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(transparent, rgba(0,0,0,0.7));
            color: white;
            padding: 10px 8px 6px;
            font-size: 11px;
            font-weight: 600;
            text-align: center;
        }
        
        /* Show More Button */
        .show-more-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: block;
            margin: 15px auto 0;
        }
        
        .show-more-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(102, 126, 234, 0.3);
        }
        
        .show-more-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        /* Loading States */
        .loading-placeholder {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        /* Empty State */
        .timeline-empty { 
            text-align: center; 
            padding: 60px 20px; 
            color: #666; 
            background: white; 
            border-radius: 15px; 
            border: 2px dashed #e0e0e0; 
        }
        
        .timeline-empty h3 { 
            color: #667eea; 
            margin-bottom: 10px; 
        }

        /* Modal Styles */
        .modal { 
            position: fixed; 
            top: 0; left: 0; right: 0; bottom: 0; 
            background: rgba(0,0,0,0.8);
            display: flex; 
            align-items: center; 
            justify-content: center; 
            z-index: 1000; 
            padding: 20px; 
        }
        
        .modal-content { 
            background: white; 
            border-radius: 15px; 
            padding: 30px; 
            max-width: 500px; 
            width: 100%; 
            text-align: center; 
            position: relative; 
        }
        
        .modal img { 
            max-width: 100%; 
            max-height: 400px; 
            border-radius: 10px; 
            margin-bottom: 20px; 
        }
        
        .close-modal { 
            position: absolute; 
            top: 10px; 
            right: 15px; 
            background: none; 
            border: none; 
            font-size: 24px; 
            cursor: pointer; 
            color: #666; 
        }

        /* Game Section (simplified) */
        .game-container { text-align: center; }
        .game-stats { 
            display: flex; 
            justify-content: center; 
            gap: 15px; 
            margin: 20px 0; 
            flex-wrap: wrap; 
        }
        .stat { 
            background: linear-gradient(45deg, #667eea, #764ba2); 
            color: white; 
            padding: 15px 20px; 
            border-radius: 15px; 
            font-size: 14px; 
            font-weight: 600;
        }
        .game-photo { 
            max-width: 400px; 
            max-height: 400px; 
            width: 100%; 
            height: 300px; 
            object-fit: contain; 
            background: #f5f5f7; 
            border-radius: 15px; 
            box-shadow: 0 15px 35px rgba(0,0,0,0.2); 
            margin: 20px auto; 
            display: block; 
        }
        .options { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); 
            gap: 15px; 
            max-width: 600px; 
            margin: 30px auto; 
        }
        .option-btn { 
            padding: 15px; 
            border: 2px solid #e0e0e0; 
            background: white; 
            border-radius: 15px; 
            cursor: pointer; 
            font-size: 16px; 
            font-weight: 600; 
            transition: all 0.3s ease; 
        }
        .option-btn:hover { 
            border-color: #667eea; 
            background: #f8f9ff; 
            transform: translateY(-2px); 
        }
        .option-btn.correct { 
            background: linear-gradient(45deg, #2ed573, #1dd1a1); 
            color: white; 
            border-color: #2ed573; 
        }
        .option-btn.incorrect { 
            background: linear-gradient(45deg, #ff4757, #ff3742); 
            color: white; 
            border-color: #ff4757; 
        }
        .game-result { 
            margin: 20px 0; 
            padding: 15px; 
            border-radius: 10px; 
            font-weight: 600; 
            font-size: 14px; 
        }
        .game-result.correct { 
            background: #d4edda; 
            color: #155724; 
            border: 1px solid #c3e6cb; 
        }
        .game-result.incorrect { 
            background: #f8d7da; 
            color: #721c24; 
            border: 1px solid #f5c6cb; 
        }

        /* Back to Top Button */
        #back-to-top {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #667eea;
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            text-align: center;
            line-height: 48px;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            z-index: 9999;
        }
        #back-to-top.visible {
            opacity: 1;
            visibility: visible;
        }
        #back-to-top:hover {
            background-color: #764ba2;
            transform: scale(1.1);
        }

        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            .container { padding: 15px; }
            .nav-buttons { gap: 8px; }
            .nav-btn { padding: 10px 12px; font-size: 13px; }
            .year-photos-grid { 
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
            }
            .stats-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
            }
            .timeline-year-header {
                padding: 12px 15px;
                font-size: 14px;
            }
            .timeline-year-header::after {
                font-size: 10px;
                left: 15px;
                bottom: 4px;
            }
            .year-header-top {
                margin-bottom: 8px;
            }
            .year-title {
                font-size: 14px;
            }
            .timeline-year-count {
                font-size: 12px;
                padding: 4px 10px;
            }
            .preview-thumb {
                width: 28px;
                height: 28px;
            }
            .preview-more {
                padding: 4px 8px;
                font-size: 10px;
            }
            .timeline-year-content {
                padding: 15px;
            }
            #back-to-top { 
                bottom: 80px; 
                right: 15px; 
                width: 45px; 
                height: 45px; 
                line-height: 43px; 
                font-size: 18px; 
            }
        }

        .header-cta{
            display:inline-block;
            margin-top:6px;
            font-size:12px;
            color:#fff;
            text-decoration: underline;
            opacity:.95;
        }
        .header-cta:hover{ opacity:1; }
        .section-title{ font-size: 1rem; line-height: 1.25; margin: 6px 0 8px;}
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Xiao Zhan Studio Gallery<br>èæå·¥ä½å®¤é«æ¸ç¸å</h1>
            <p class="subtitle" style="font-weight: 600; color: white;">Explore high-resolution photos from XZ Studio timeline</p>
            <a href="#explore-links" class="header-cta">Explore links â</a>
        </header>

        <nav class="nav-buttons">
            <button class="nav-btn active" data-section="gallery">Photo Timeline<br>æ¶é´çº¿ç¸å</button>
            <button class="nav-btn" data-section="game">Time Game<br>æ¶é´æ¸¸æ</button>
        </nav>

        <!-- Gallery Section -->
        <div id="gallery-section" class="content-section">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalPhotosDisplay">0</div>
                    <div class="stat-label">Total Photos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="yearsSpanDisplay">0</div>
                    <div class="stat-label">Years Covered</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="expandedYearsDisplay">0</div>
                    <div class="stat-label">Years Expanded</div>
                </div>
            </div>

            <input type="text" class="search-bar" placeholder="Search photos by year, month, or date..." id="searchInput">

            <div class="timeline-container" id="timelineContainer">
                <div class="timeline-empty">
                    <h3>Loading Photo Timeline...</h3>
                    <p>Please wait while we organize your photos by year.</p>
                </div>
            </div>
        </div>

        <!-- Game Section -->
        <div id="game-section" class="content-section hidden">
            <div class="game-container">
                <h2 class="section-title">When Was This Photo Taken?</h2>
                <p style="font-size:13px; color:#1565C0;">Click "Start Game" to begin!</p>
                <div style="background:#e8f4ff; padding:15px; border-radius:10px; margin:20px auto; max-width:500px; border-left:4px solid #2196F3;">
                    <p style="margin:0; font-size:12px; color:#1565C0;"><strong>ð¡ ççç:</strong> ç¸æ¡éçç§çæ¯ä»ä¹æ¶åç§çï¼<br>ç¹å»"å¼å§æ¸¸æï¼"ï¼æµè¯ä½ çç¼åå§ï¼</p>
                </div>
                <div class="game-stats">
                    <div class="stat">Score: <span id="score">0</span></div>
                    <div class="stat">Streak: <span id="streak">0</span></div>
                    <div class="stat">Total: <span id="totalQuestions">0</span></div>
                </div>
                <div id="gameContent">
                    <img id="gamePhoto" class="game-photo" alt="Guess the date">
                    <div id="gameOptions" class="options"></div>
                    <div id="gameResult" class="game-result hidden"></div>
                    <button id="nextQuestion" class="btn primary hidden">Next Question</button>
                </div>
                <div class="game-controls">
                    <button id="startGame" class="btn primary">Start Game å¼å§æ¸¸æï¼</button>
                    <button id="newGame" class="btn primary hidden">New Game</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Photo Modal -->
    <div id="photoModal" class="modal hidden">
        <div class="modal-content">
            <button class="close-modal" onclick="closeModal()">&times;</button>
            <img id="modalPhoto" alt="Full size photo">
            <h3 id="modalTitle"></h3>
            <p id="modalDate"></p>
            <div class="share-buttons">
                <a class="share-btn" id="weiboLinkBtn" target="_blank" rel="noopener"
                   style="background:#fa2a55; color:white; display:none;">Weibo Link</a>
            </div>
        </div>
    </div>

    <!-- Back to Top Button -->
    <div id="back-to-top">â</div>

    <script>
        /* ---------- Core Variables ---------- */
        let photoData = [];
        let gameScore = 0, gameStreak = 0, totalQuestions = 0, currentPhoto = null, gameActive = false;
        let expandedYears = new Set();
        let yearPhotoDisplayCount = {}; // Track how many photos are shown per year
        
        /* ---------- ROW-BASED DISPLAY CONFIGURATION ---------- */
        const ROWS_PER_YEAR_INITIAL = 2; // Show 2 rows initially per year
        const ROWS_PER_LOAD = 10; // Load 2 more rows when "Show More" is clicked
        
        // Function to calculate photos per row based on screen width
        function calculatePhotosPerRow() {
            const screenWidth = window.innerWidth;
            
            if (screenWidth <= 768) {
                return 3; // Mobile: 3 photos per row (matches CSS media query)
            } else {
                // Desktop/tablet: calculate based on available width
                const containerWidth = Math.min(1000, screenWidth - 40); // max-width: 1000px, padding: 20px
                const gridWidth = containerWidth - 40; // grid padding: 20px each side
                const photoWidth = 120; // minmax(120px, 1fr)
                const gap = 12;
                
                const photosPerRow = Math.floor((gridWidth + gap) / (photoWidth + gap));
                return Math.max(3, Math.min(8, photosPerRow)); // Between 3-8 photos per row
            }
        }
        
        // Function to convert rows to photo count
        function calculatePhotosFromRows(rows) {
            const photosPerRow = calculatePhotosPerRow();
            return rows * photosPerRow;
        }
        
        // Intersection Observer for lazy loading
        let imageObserver = null;
        
        document.addEventListener('DOMContentLoaded', () => {
            setupNavigation();
            setupSearch();
            setupIntersectionObserver();
            loadPhotoData();
            
            console.log(`Initial screen: ${window.innerWidth}px, Photos per row: ${calculatePhotosPerRow()}, Initial photos: ${calculatePhotosFromRows(ROWS_PER_YEAR_INITIAL)}`);
        });

        /* ---------- IMGUR THUMBNAIL GENERATION ---------- */
        function generateImgurThumbnail(originalUrl, size = 'm') {
            /*
            Imgur thumbnail sizes:
            's' = small square (90x90)
            'b' = big square (160x160) 
            't' = small thumbnail (160x160)
            'm' = medium thumbnail (320x320) - RECOMMENDED
            'l' = large thumbnail (640x640)
            'h' = huge thumbnail (1024x1024)
            */
            
            // Extract the image ID and extension from Imgur URL
            const match = originalUrl.match(/https:\/\/i\.imgur\.com\/([^.]+)\.(\w+)/);
            
            if (match) {
                const [, imageId, extension] = match;
                return `https://i.imgur.com/${imageId}${size}.${extension}`;
            }
            
            // Fallback to original URL if pattern doesn't match
            console.warn('Could not parse Imgur URL for thumbnail:', originalUrl);
            return originalUrl;
        }

        /* ---------- Data Loading ---------- */
        async function loadPhotoData() {
            try {
                const cacheBuster = Date.now();
                const res = await fetch(`photoData.json?v=${cacheBuster}`, { 
                    cache: 'no-store'
                });
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();
                if (!Array.isArray(data)) throw new Error('JSON is not an array');
                
                photoData = data;
                initializeTimeline();
                
            } catch (err) {
                console.error('Failed to load photoData.json:', err);
                document.getElementById('timelineContainer').innerHTML = `
                    <div class="timeline-empty">
                        <h3>Could not load photo data</h3>
                        <p>Please check your connection and refresh the page.</p>
                    </div>`;
            }
        }

        /* ---------- Timeline Initialization ---------- */
        function initializeTimeline() {
            if (photoData.length === 0) {
                document.getElementById('timelineContainer').innerHTML = `
                    <div class="timeline-empty">
                        <h3>No photos found</h3>
                        <p>Add photoData.json to your repository to display photos.</p>
                    </div>`;
                return;
            }

            // Group photos by year
            const photosByYear = {};
            photoData.forEach(photo => {
                if (!photosByYear[photo.year]) {
                    photosByYear[photo.year] = [];
                    // Use row-based calculation for initial display count
                    yearPhotoDisplayCount[photo.year] = calculatePhotosFromRows(ROWS_PER_YEAR_INITIAL);
                }
                photosByYear[photo.year].push(photo);
            });

            // Sort photos within each year by date (newest first)
            Object.keys(photosByYear).forEach(year => {
                photosByYear[year].sort((a, b) => new Date(b.date) - new Date(a.date));
            });

            createTimelineHTML(photosByYear);
            updateStats();
            initializeGame();
            
            // Auto-expand the most recent year
            const sortedYears = Object.keys(photosByYear).sort((a, b) => parseInt(b) - parseInt(a));
            if (sortedYears.length > 0) {
                const mostRecentYear = sortedYears[0];
                setTimeout(() => {
                    toggleYear(mostRecentYear);
                }, 100);
            }
        }

        /* ---------- Timeline HTML Generation ---------- */
        function createTimelineHTML(photosByYear) {
            const sortedYears = Object.keys(photosByYear).sort((a, b) => parseInt(b) - parseInt(a));
            
            const timelineHTML = sortedYears.map(year => {
                const photos = photosByYear[year];
                const displayCount = yearPhotoDisplayCount[year] || calculatePhotosFromRows(ROWS_PER_YEAR_INITIAL);
                const hasMore = photos.length > displayCount;
                
                // Calculate row information for display
                const photosPerRow = calculatePhotosPerRow();
                const displayingRows = Math.ceil(displayCount / photosPerRow);
                const totalRows = Math.ceil(photos.length / photosPerRow);
                
                // Create preview thumbnails for collapsed state (using Imgur thumbnails)
                const previewPhotos = photos.slice(0, 4);
                const previewHTML = `
                    <div class="year-preview">
                        ${previewPhotos.map(photo => {
                            const thumbnailUrl = generateImgurThumbnail(photo.url, 's'); // Small 90x90 for preview
                            return `<img src="${thumbnailUrl}" alt="Preview" class="preview-thumb">`;
                        }).join('')}
                        ${photos.length > 4 ? `<div class="preview-more">+${photos.length - 4}</div>` : ''}
                    </div>
                `;
                
                return `
                    <div class="timeline-year" data-year="${year}" data-photo-count="${photos.length}">
                        <div class="timeline-year-header" onclick="toggleYear('${year}')">
                            <div class="year-header-content">
                                <div class="year-header-top">
                                    <span class="year-title">${year}</span>
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <span class="timeline-year-count">${photos.length} photos (${totalRows} rows)</span>
                                        <span class="expand-icon">â¼</span>
                                    </div>
                                </div>
                                ${previewHTML}
                            </div>
                        </div>
                        <div class="timeline-year-content">
                            <div class="year-photos-grid" id="photos-${year}">
                                ${generatePhotosHTML(photos.slice(0, displayCount))}
                            </div>
                            ${hasMore ? `
                                <button class="show-more-btn" onclick="loadMorePhotosForYear('${year}')">
                                    Show More Photos (${Math.ceil((photos.length - displayCount) / photosPerRow)} more rows, ${photos.length - displayCount} remaining)
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('timelineContainer').innerHTML = timelineHTML;
            setupLazyLoading();
        }

        /* ---------- Photo HTML Generation with Thumbnails ---------- */
        function generatePhotosHTML(photos) {
            return photos.map(photo => {
                // Generate thumbnail URL for grid display
                const thumbnailUrl = generateImgurThumbnail(photo.url, 'm'); // Medium 320x320 for grid
                
                return `
                    <div class="timeline-photo" onclick="openPhotoModal(${photo.id})">
                        <img data-src="${thumbnailUrl}" 
                             data-fullsize="${photo.url}"
                             alt="Photo ${photo.id}" 
                             class="lazy-image">
                        <div class="photo-overlay">
                            ${photo.month} ${photo.year}
                        </div>
                    </div>
                `;
            }).join('');
        }

        /* ---------- Year Toggle Functionality ---------- */
        function toggleYear(year) {
            const yearElement = document.querySelector(`[data-year="${year}"]`);
            const isExpanded = yearElement.classList.contains('expanded');
            
            if (isExpanded) {
                yearElement.classList.remove('expanded');
                expandedYears.delete(year);
                // Unload images to save memory
                unloadYearImages(year);
            } else {
                yearElement.classList.add('expanded');
                expandedYears.add(year);
                
                // Reset to initial photo count when expanding (performance improvement)
                const initialCount = calculatePhotosFromRows(ROWS_PER_YEAR_INITIAL);
                yearPhotoDisplayCount[year] = initialCount;
                
                // Rebuild the year content with only initial photos
                const yearPhotos = photoData.filter(p => p.year === year);
                const photosGrid = document.getElementById(`photos-${year}`);
                const displayPhotos = yearPhotos.slice(0, initialCount);
                const hasMore = yearPhotos.length > initialCount;
                
                // Update photos grid
                photosGrid.innerHTML = generatePhotosHTML(displayPhotos);
                
                // Update or create "Show More" button
                let showMoreBtn = photosGrid.parentElement.querySelector('.show-more-btn');
                if (hasMore) {
                    const remaining = yearPhotos.length - initialCount;
                    const remainingRows = Math.ceil(remaining / calculatePhotosPerRow());
                    
                    if (showMoreBtn) {
                        showMoreBtn.textContent = `Show More Photos (${remainingRows} more rows, ${remaining} remaining)`;
                        showMoreBtn.style.display = 'block';
                    } else {
                        photosGrid.insertAdjacentHTML('afterend', `
                            <button class="show-more-btn" onclick="loadMorePhotosForYear('${year}')">
                                Show More Photos (${remainingRows} more rows, ${remaining} remaining)
                            </button>
                        `);
                    }
                } else if (showMoreBtn) {
                    showMoreBtn.style.display = 'none';
                }
                
                // Setup lazy loading for this year
                setupLazyLoadingForYear(year);
            }
            
            updateStats();
        }

        /* ---------- Load More Photos for Year (Row-Based) ---------- */
        function loadMorePhotosForYear(year) {
            const yearPhotos = photoData.filter(p => p.year === year);
            const currentDisplayCount = yearPhotoDisplayCount[year];
            
            // Calculate how many more photos to load based on rows
            const additionalPhotos = calculatePhotosFromRows(ROWS_PER_LOAD);
            const newDisplayCount = Math.min(currentDisplayCount + additionalPhotos, yearPhotos.length);
            
            yearPhotoDisplayCount[year] = newDisplayCount;
            
            const photosGrid = document.getElementById(`photos-${year}`);
            const newPhotos = yearPhotos.slice(currentDisplayCount, newDisplayCount);
            
            // Add new photos
            const newPhotosHTML = generatePhotosHTML(newPhotos);
            photosGrid.insertAdjacentHTML('beforeend', newPhotosHTML);
            
            // Update or remove the "Show More" button
            const showMoreBtn = photosGrid.parentElement.querySelector('.show-more-btn');
            if (newDisplayCount >= yearPhotos.length) {
                if (showMoreBtn) showMoreBtn.remove();
            } else {
                const remaining = yearPhotos.length - newDisplayCount;
                const remainingRows = Math.ceil(remaining / calculatePhotosPerRow());
                showMoreBtn.textContent = `Show More Photos (${remainingRows} more rows, ${remaining} remaining)`;
            }
            
            // Setup lazy loading for new images
            setupLazyLoadingForYear(year);
        }

        /* ---------- Lazy Loading Setup ---------- */
        function setupIntersectionObserver() {
            imageObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const img = entry.target;
                        if (img.dataset.src && !img.src) {
                            img.src = img.dataset.src;
                            img.onload = () => {
                                img.classList.remove('loading-placeholder');
                                img.removeAttribute('data-src');
                            };
                            img.onerror = () => {
                                // If thumbnail fails, try full-size image
                                if (img.dataset.fullsize && img.dataset.fullsize !== img.dataset.src) {
                                    img.src = img.dataset.fullsize;
                                } else {
                                    img.alt = 'Failed to load';
                                    img.classList.remove('loading-placeholder');
                                }
                            };
                        }
                        imageObserver.unobserve(img);
                    }
                });
            }, {
                rootMargin: '50px'
            });
        }

        function setupLazyLoading() {
            const lazyImages = document.querySelectorAll('.lazy-image[data-src]');
            lazyImages.forEach(img => {
                img.classList.add('loading-placeholder');
                if (imageObserver) {
                    imageObserver.observe(img);
                }
            });
        }

        function setupLazyLoadingForYear(year) {
            const yearImages = document.querySelectorAll(`#photos-${year} .lazy-image[data-src]`);
            yearImages.forEach(img => {
                img.classList.add('loading-placeholder');
                if (imageObserver) {
                    imageObserver.observe(img);
                }
            });
        }

        function unloadYearImages(year) {
            const yearImages = document.querySelectorAll(`#photos-${year} img`);
            yearImages.forEach(img => {
                if (img.src && img.src !== img.dataset.src) {
                    img.dataset.src = img.src;
                    img.src = '';
                    img.classList.add('loading-placeholder');
                }
            });
        }

        /* ---------- Window Resize Handling ---------- */
        let resizeTimeout;
        window.addEventListener('resize', function() {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                const newPhotosPerRow = calculatePhotosPerRow();
                console.log(`Window resized. New photos per row: ${newPhotosPerRow}`);
                
                // Update button text to reflect new row calculations
                document.querySelectorAll('.show-more-btn').forEach(btn => {
                    const yearMatch = btn.getAttribute('onclick').match(/loadMorePhotosForYear\('(\d+)'\)/);
                    if (yearMatch) {
                        const year = yearMatch[1];
                        const yearPhotos = photoData.filter(p => p.year === year);
                        const currentDisplayCount = yearPhotoDisplayCount[year];
                        const remaining = yearPhotos.length - currentDisplayCount;
                        const remainingRows = Math.ceil(remaining / newPhotosPerRow);
                        btn.textContent = `Show More Photos (${remainingRows} more rows, ${remaining} remaining)`;
                    }
                });
            }, 250);
        });

        /* ---------- Search Functionality ---------- */
        function setupSearch() {
            const searchInput = document.getElementById('searchInput');
            let searchTimeout;
            
            searchInput.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    performSearch(this.value.toLowerCase().trim());
                }, 300);
            });
        }

        function performSearch(query) {
            if (!query) {
                // Show all years
                document.querySelectorAll('.timeline-year').forEach(yearEl => {
                    yearEl.style.display = 'block';
                });
                return;
            }

            // Filter years based on search
            const matchingYears = new Set();
            
            photoData.forEach(photo => {
                const matchesYear = photo.year.includes(query);
                const matchesMonth = photo.month.toLowerCase().includes(query);
                const matchesDate = photo.date.includes(query);
                const matchesTags = Array.isArray(photo.tags) && 
                    photo.tags.some(tag => String(tag).toLowerCase().includes(query));
                
                if (matchesYear || matchesMonth || matchesDate || matchesTags) {
                    matchingYears.add(photo.year);
                }
            });

            // Show/hide years based on search results
            document.querySelectorAll('.timeline-year').forEach(yearEl => {
                const year = yearEl.dataset.year;
                if (matchingYears.has(year)) {
                    yearEl.style.display = 'block';
                    // Auto-expand matching years
                    if (!yearEl.classList.contains('expanded')) {
                        toggleYear(year);
                    }
                } else {
                    yearEl.style.display = 'none';
                }
            });
        }

        /* ---------- Statistics ---------- */
        function updateStats() {
            const totalPhotos = photoData.length;
            const totalYears = new Set(photoData.map(p => p.year)).size;
            const expandedCount = expandedYears.size;
            
            document.getElementById('totalPhotosDisplay').textContent = totalPhotos.toLocaleString();
            document.getElementById('yearsSpanDisplay').textContent = totalYears;
            document.getElementById('expandedYearsDisplay').textContent = expandedCount;
        }

        /* ---------- Navigation ---------- */
        function setupNavigation() {
            const navBtns = document.querySelectorAll('.nav-btn');
            navBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const section = this.getAttribute('data-section');
                    showSection(section);
                    navBtns.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                });
            });
        }
        
        function showSection(section) {
            document.querySelectorAll('.content-section').forEach(s => s.classList.add('hidden'));
            document.getElementById(section + '-section').classList.remove('hidden');
            if (section === 'game') initializeGame();
        }

        /* ---------- Modal ---------- */
        function openPhotoModal(photoId) {
            const photo = photoData.find(p => p.id === photoId);
            if (!photo) return;
            
            // Always use full-size image in modal
            document.getElementById('modalPhoto').src = photo.url;
            document.getElementById('modalTitle').textContent = `Photo ${photo.id}`;
            document.getElementById('modalDate').textContent = `Taken in ${photo.month} ${photo.year}`;
            
            const weiboBtn = document.getElementById('weiboLinkBtn');
            if (photo.weibo && typeof photo.weibo === 'string' && photo.weibo.trim()) {
                const w = photo.weibo.trim();
                const normalized = /^https?:\/\//i.test(w) ? w : `https://${w}`;
                weiboBtn.href = normalized; 
                weiboBtn.style.display = 'inline-block';
            } else {
                weiboBtn.style.display = 'none';
            }
            
            document.getElementById('photoModal').classList.remove('hidden');
        }
        
        function closeModal() { 
            document.getElementById('photoModal').classList.add('hidden'); 
        }

        // Close modal when clicking outside or pressing escape
        document.getElementById('photoModal').addEventListener('click', function(e) { 
            if (e.target === this) closeModal(); 
        });
        document.addEventListener('keydown', function(e) { 
            if (e.key === 'Escape') closeModal(); 
        });

        /* ---------- Game Functionality (same as original) ---------- */
        document.getElementById('startGame').addEventListener('click', startGame);
        document.getElementById('newGame').addEventListener('click', newGame);
        document.getElementById('nextQuestion').addEventListener('click', nextQuestion);

        function initializeGame() {
            if (!gameActive && photoData.length > 0) {
                document.getElementById('gamePhoto').src = createDefaultGameImage();
            } else if (photoData.length === 0) {
                document.getElementById('gamePhoto').src = createDefaultGameImage();
                const startBtn = document.getElementById('startGame');
                startBtn.textContent = 'Add Photos First'; 
                startBtn.disabled = true; 
                startBtn.style.opacity = '0.5';
            }
        }
        
        function startGame() {
            if (photoData.length === 0) { 
                alert('No photos available for the game!'); 
                return; 
            }
            gameActive = true; 
            document.getElementById('startGame').classList.add('hidden');
            document.getElementById('newGame').classList.remove('hidden'); 
            nextQuestion();
        }
        
        function newGame() {
            if (photoData.length === 0) { 
                alert('No photos available for the game!'); 
                return; 
            }
            gameScore = 0; 
            gameStreak = 0; 
            totalQuestions = 0; 
            updateGameStats(); 
            nextQuestion();
        }
        
        function nextQuestion() {
            if (photoData.length === 0) { 
                alert('No photos available for the game!'); 
                return; 
            }
            document.getElementById('gameResult').classList.add('hidden');
            document.getElementById('nextQuestion').classList.add('hidden');
            currentPhoto = photoData[Math.floor(Math.random() * photoData.length)];
            // Use full-size image for game
            document.getElementById('gamePhoto').src = currentPhoto.url;
            const options = generateOptions(currentPhoto); 
            displayGameOptions(options);
        }
        
        function generateOptions(correctPhoto) {
            const months = ['January','February','March','April','May','June','July','August','September','October','November','December'];
            const years = [...new Set(photoData.map(p => p.year))];
            const options = [`${correctPhoto.month} ${correctPhoto.year}`];
            while (options.length < 4) {
                const randomMonth = months[Math.floor(Math.random()*months.length)];
                const randomYear = years[Math.floor(Math.random()*years.length)] || correctPhoto.year;
                const option = `${randomMonth} ${randomYear}`;
                if (!options.includes(option)) options.push(option);
            }
            return options.sort(() => Math.random() - 0.5);
        }
        
        function displayGameOptions(options) {
            const optionsContainer = document.getElementById('gameOptions');
            optionsContainer.innerHTML = options.map(option => 
                `<button class="option-btn" onclick="selectOption('${option}')">${option}</button>`
            ).join('');
        }
        
        function selectOption(selectedOption) {
            const correctAnswer = `${currentPhoto.month} ${currentPhoto.year}`;
            const isCorrect = selectedOption === correctAnswer; 
            totalQuestions++;
            if (isCorrect) { 
                gameScore++; 
                gameStreak++; 
                showGameResult('Correct!', 'correct'); 
            } else { 
                gameStreak = 0; 
                showGameResult(`Wrong! It was ${correctAnswer}`, 'incorrect'); 
            }
            updateGameStats(); 
            highlightOptions(selectedOption, correctAnswer);
            document.getElementById('nextQuestion').classList.remove('hidden');
        }
        
        function showGameResult(message, type) {
            const resultDiv = document.getElementById('gameResult');
            resultDiv.textContent = message; 
            resultDiv.className = `game-result ${type}`; 
            resultDiv.classList.remove('hidden');
        }
        
        function highlightOptions(selectedOption, correctAnswer) {
            const optionBtns = document.querySelectorAll('.option-btn');
            optionBtns.forEach(btn => {
                btn.style.pointerEvents = 'none';
                if (btn.textContent === correctAnswer) btn.classList.add('correct');
                else if (btn.textContent === selectedOption && selectedOption !== correctAnswer) btn.classList.add('incorrect');
            });
        }
        
        function updateGameStats() {
            document.getElementById('score').textContent = gameScore;
            document.getElementById('streak').textContent = gameStreak;
            document.getElementById('totalQuestions').textContent = totalQuestions;
        }

        function createDefaultGameImage() {
            const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="400" height="300" viewBox="0 0 400 300">
                <defs>
                    <linearGradient id="bg" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#667eea;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#764ba2;stop-opacity:1" />
                    </linearGradient>
                </defs>
                <rect width="400" height="300" fill="url(#bg)"/>
                <text x="200" y="150" text-anchor="middle" font-family="Arial, sans-serif" font-size="24" font-weight="bold" fill="white">Game Photo Here</text>
            </svg>`;
            return 'data:image/svg+xml,' + encodeURIComponent(svg);
        }

        /* ---------- Back to Top Button ---------- */
        (function(){
            const btn = document.getElementById('back-to-top');
            if (!btn) return;
            
            let ticking = false;
            
            function updateBackToTop() {
                if (window.scrollY > 300) {
                    btn.classList.add('visible');
                } else {
                    btn.classList.remove('visible');
                }
                ticking = false;
            }
            
            window.addEventListener('scroll', function() {
                if (!ticking) {
                    requestAnimationFrame(updateBackToTop);
                    ticking = true;
                }
            });
            
            btn.addEventListener('click', function() {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
        })();

        /* ---------- Debug Function ---------- */
        function debugRowCalculations() {
            const photosPerRow = calculatePhotosPerRow();
            const initialPhotos = calculatePhotosFromRows(ROWS_PER_YEAR_INITIAL);
            const loadMorePhotos = calculatePhotosFromRows(ROWS_PER_LOAD);
            
            console.log('=== ROW-BASED DISPLAY DEBUG ===');
            console.log(`Screen width: ${window.innerWidth}px`);
            console.log(`Photos per row: ${photosPerRow}`);
            console.log(`Initial rows: ${ROWS_PER_YEAR_INITIAL} = ${initialPhotos} photos`);
            console.log(`Load more rows: ${ROWS_PER_LOAD} = ${loadMorePhotos} photos`);
            
            alert(`ROW-BASED DISPLAY INFO:
            
Screen: ${window.innerWidth}px wide
Photos per row: ${photosPerRow}
Initial: ${ROWS_PER_YEAR_INITIAL} rows = ${initialPhotos} photos
Load more: ${ROWS_PER_LOAD} rows = ${loadMorePhotos} photos

Check console for detailed logs.`);
        }
    </script>

    <!-- Footer -->
    <style>
        .site-footer {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 0;
            margin-top: 50px;
            text-align: center;
        }
        .footer-content { margin-bottom: 15px; }
        .footer-link {
            color: white;
            text-decoration: underline;
            font-weight: 600;
            display: inline-block;
            padding: 8px 12px;
            border-radius: 8px;
            transition: all 0.3s ease;
            margin: 0 8px;
        }
        .footer-link:hover { 
            opacity: 0.9; 
            transform: translateY(-1px); 
            background: rgba(255,255,255,0.1);
        }
        #terms-content {
            background-color: rgba(255,255,255,0.1);
            border-radius: 10px;
            margin: 15px auto 0;
            text-align: left;
            max-width: 700px;
            padding: 15px 20px; 
            display: none;
        }
        #terms-content ul { 
            list-style: disc; 
            padding-left: 20px;  
            margin: 10px 0; 
        }
        #terms-content li { 
            margin: 5px 0; 
        }
        .copyright-notice {
            opacity: 0.9;
            margin-top: 10px;
            font-size: 0.9rem;
        }
    </style>
    
    <footer class="site-footer">
        <div class="footer-content">
            <div style="margin-bottom:15px;font-weight:700;">Explore more</div>
            <a class="footer-link" href="https://canadaxfx.github.io/XZworks/" target="_blank" rel="noopener">Screen Arts of Xiao Zhan</a>
            <a class="footer-link" href="https://www.youtube.com/@CanadaXFX" target="_blank" rel="noopener">CanadaXFX YouTube Channel</a>
        </div>

        <div class="copyright-notice">&copy; 2025 CanadaXFX. All rights reserved.</div>

        <a href="#" id="terms-toggle" class="footer-link">Terms of Use</a>
        <div id="terms-content">
            <ul>
                <li>All images and content related to Xiao Zhan belong to their respective copyright owners.</li>
                <li>All content on this site is curated and organized Â© 2025 CanadaXFX.</li>
                <li>AI training is strictly prohibited.</li>
                <li>The original content, design, and code of this website may not be reproduced, distributed, or used without explicit permission.</li>
                <li>Personal and non-commercial use only.</li>
            </ul>
        </div>
    </footer>
    
    <script>
        document.getElementById('terms-toggle').addEventListener('click', function(e){
            e.preventDefault();
            const termsContent = document.getElementById('terms-content');
            if(termsContent) {
                termsContent.style.display = (termsContent.style.display === 'none' || !termsContent.style.display) ? 'block' : 'none';
            }
        });
    </script>
</body>
</html>